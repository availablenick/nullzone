%nav.localization
  = link_to 'Início', main_path
  >
  = link_to 'Área geral', topicos_path

%br/

- days_array = ['Domingo', 'Segunda-feira',
-  'Terça-feira', 'Quarta-feira', 'Quinta-feira',
-  'Sexta-feira', 'Sábado']

%h2.h-topico
  = @topico.titulo
%h5.h-topico
  = @topico.usuario.login
  _>
  - date = @topico.created_at
  = "#{days_array[date.wday]}, "
  = date.strftime("%d/%m/%y")
  às
  = date.strftime("%R")

- page_number = 1 if !page_number
- if params[:page]
  - page_number = params[:page].to_i

-# Botões das páginas
- num = @topico.posts.count + 1
- if !(num / 10 < 1 || (num / 10 == 1 && num % 10 == 0))
  %div.buttons-div.first-buttons-div
    %form{ action: topico_path(@topico), method: :get }
      - ((num / 10) + 1).times do |i|
        - if i+1 == page_number
          %button.selected-button{ disabled: true }
            = page_number
        - else 
          %input{ type: 'submit', name: :page, value: "#{i+1}" }

-# Cada página fica com 10 posts
- count_begin = 0
- count_end = 9
- if page_number > 1
  - count_begin += (page_number-1) * 9
  - count_end = count_begin + 9
  - count = count_begin + 1
- else
  - count = count_begin

- if count == 0
  -# Para preencher espaço e não quebrar a contagem, já que
  -# a primeira resposta não é um post
  - posts_array = [nil]
  - posts_array += @topico.posts.slice(count_begin, count_end)
- else
  - posts_array = @topico.posts.slice(count_begin, count_end)

-# Cria um espaço para cada post
- posts_array.each do |post|
  %div.post-wrapper{ id: "#{count}" }
    %div.user-info
      - info_src = post
      - info_src = @topico if count == 0
      %b
        = link_to info_src.usuario.login, usuario_path(info_src.usuario)
      %br/
      = "Cadastro: #{info_src.usuario.created_at.strftime("%d/%m/%y")}"
      %br/
      = "Posts: #{info_src.usuario.topicos.count + info_src.usuario.posts.count}"
      %br/
    %div.user-msg
      %span.post-info
        - date = info_src.created_at
        = "#{days_array[date.wday]}, "
        = date.strftime("%d/%m/%y")
        às
        = date.strftime("%R")
        %span.post-right
          - if info_src.usuario.login == @topico.usuario.login
            %span.post-op-tag
              OP
          %span.post-num
            = "##{count+1}"
 
      %hr/
      = info_src.mensagem
      - if current_usuario
        - if current_usuario.login == info_src.usuario.login or |
        current_usuario.login == 'ADM' |
          %span.options
            - if count > 0  
              %b
                = link_to 'Editar', edit_topico_post_path(post.topico, post, page: page_number, count: count)
              |
              %b
                = link_to 'Deletar', [post.topico, post],
                  method: :delete,
                  data: { confirm: 'Deletar post?' }
            - else
              %b
                = link_to 'Editar tópico', edit_topico_path(@topico)
      
      - if info_src.created_at != info_src.updated_at
        %span.post-edit-msg
          Editado pela última vez em:
          - date = info_src.updated_at
          = "#{days_array[date.wday]}, "
          = date.strftime("%d/%m/%y")
          às
          = date.strftime("%R")
  - count += 1

-# Botões das páginas
- num = @topico.posts.count + 1
- if !(num / 10 < 1 || (num / 10 == 1 && num % 10 == 0))
  %div.buttons-div
    %form{ action: topico_path(@topico), method: :get }
      - ((num / 10) + 1).times do |i|
        - if i+1 == page_number
          %button.selected-button{ disabled: true }
            = page_number
        - else 
          %input{ type: 'submit', name: :page, value: "#{i+1}" }

-# Caixa de envio de posts
%br/
- if current_usuario
  = form_with model: [@topico, @topico.posts.build], local: true do |form|
    %p
      = form.label :mensagem
      %br/
      = form.text_area :mensagem, rows: 15, cols: 65
    
    %p
      = form.submit 'Enviar post'
- else
  Você precisa logar para enviar um post
  %br/
  %br/
